{% extends "base.html" %}
{% block content %}

<div class="mt-3">
  토렌트 파일
</div>

<form>
  <div class="custom-file mt-2">
    <input type="file" accept=".torrent" class="custom-file-input" id="customFile">
    <label class="custom-file-label" for="customFile"></label>
  </div>
  <button id="get_info_local_btn" name="get_info_local_btn" class="btn btn-sm btn-outline-success mt-2 mb-1">정보 가져오기</button>
</form>

<form>
    <div class="form-group mt-3 mb-2">
        <label for="torrent_url">웹 주소</label>
        <input type="url" class="form-control" id="torrent_url" aria-describedby="urlhelp" placeholder="">
        <small id="urlhelp" class="form-text text-muted">http로 시작하는 주소를 입력하세요.</small>
    </div>
    <button id="get_info_url_btn" name="get_info_url_btn" class="btn btn-sm btn-outline-success mb-1">정보 가져오기</button>
</form>

<div id="summary_card" class="card mt-3 mb-3">
    <div class="card-header">토렌트 정보
        <a href="#" id="torrent_file" class="card-link ml-2"></a>
    </div>
    <div class="card-body">
        <div class="collapse" id="div_torrent_info"></div>
    </div>
</div>
</div> <!--전체-->




<script type="text/javascript">
  var package_name = 'torrent_info';
  {# var current_file = null; #}
  var current_info = null;
  
  $(".custom-file-input").on("change", function() {
    var fileName = $(this).val().split("\\").pop();
    $(this).siblings(".custom-file-label").addClass("selected").html(fileName);
  });

  $("body").on('click', '#get_info_local_btn', function(e) {
      e.preventDefault();
      var current_file = $('#customFile').prop('files')[0];
      if (jQuery.isEmptyObject(current_file)) {
          $.notify('<strong>파일을 첨부해 주세요!</strong>', {
              type: 'warning'
          });
          return;
      }
      var form_data = new FormData();
      form_data.append('file',current_file);
      $.ajax({
          url: '/' + package_name + '/api/torrent_info_file',
          type: "POST",
          cache: false,
          data: form_data,
          processData: false,
          contentType: false,
          success: function(data) {
              if (data.success) {
                  current_info = data.info;
                  show_info(data.info);
              } else {
                  $.notify('<strong>실패하였습니다!!!</strong><br>' + data.log, {
                      type: 'warning'
                  });
              }
          }
      });
  });

    $("body").on('click', '#get_info_url_btn', function(e) {
        e.preventDefault();
        torrent_url = document.getElementById("torrent_url").value;
        if (!torrent_url.startsWith("http")) {
            $.notify('<strong>올바른 토렌트 주소를 입력하세요!</strong>', {
                type: 'warning'
            });
            return;
        }
        $.ajax({
            url: '/' + package_name + '/api/torrent_info_url',
            type: "POST",
            cache: false,
            data: {
                torrent_url: torrent_url
            },
            dataType: "json",
            success: function(data) {
                if (data.success) {
                    current_info = data.info;
                    show_info(data.info);
                } else {
                    $.notify('<strong>실패하였습니다!!!</strong><br>' + data.log, {
                        type: 'warning'
                    });
                }
            }
        });
    });

  function show_info(data) {
      // make a link to torrent_file
      document.getElementById("torrent_file").innerHTML = data.name + '.torrent';
      $('#torrent_file').prop('href', '/' + package_name + '/api/download_torrent?hash=' + data.info_hash);
      // torrent_info
      document.getElementById("div_torrent_info").innerHTML = "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
      $('#div_torrent_info').collapse('show');
  }
    
</script>


{% endblock %}