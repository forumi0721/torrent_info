{% extends "base.html" %} {% block content %}

<form>
    <div class="form-group mt-3">
        <label for="magnet_uri">마그넷 주소</label>
        <input type="url" class="form-control" id="magnet_uri" aria-describedby="urlhelp" placeholder="">
        <small id="urlhelp" class="form-text text-muted">magnet:?xt=urn:btih:로 시작하는 주소를 입력하세요.</small>
    </div>
    <button id="get_magnet_info_btn" name="get_magnet_info_btn" class="btn btn-sm btn-outline-success mb-1">정보 가져오기</button>
</form>

<div id="summary_card" class="card mt-3 mb-3">
    <div class="card-header">토렌트 정보
        <a href="#" id="torrent_file" class="card-link ml-2"></a>
    </div>
    <div class="card-body">
        <p id="etime" class="card-text mt-0 mb-1 text-sm-right small text-muted"></p>
        <div class="collapse" id="div_torrent_info"></div>
    </div>
</div>
<!--전체-->



<script type="text/javascript">
    var package_name = 'torrent_info';
    var current_info = null;

    $("body").on('click', '#get_magnet_info_btn', function(e) {
        e.preventDefault();
        magnet_uri = document.getElementById("magnet_uri").value;
        if (!magnet_uri.startsWith("magnet:?xt=urn:btih:")) {
            $.notify('<strong>올바른 마그넷 주소를 입력하세요!</strong>', {
                type: 'warning'
            });
            return;
        }
        $.ajax({
            url: '/' + package_name + '/api/magnet_info',
            type: "POST",
            cache: false,
            data: {
                magnet_uri: magnet_uri
            },
            dataType: "json",
            success: function(data) {
                if (data.success) {
                    current_info = data.info;
                    show_info(data.info);
                } else {
                    $.notify('<strong>실패하였습니다!!!</strong><br>' + data.log, {
                        type: 'warning'
                    });
                }
            }
        });
    });

    function show_info(data) {
        // make a link to torrent_file
        document.getElementById("torrent_file").innerHTML = data.name + '.torrent';
        $('#torrent_file').prop('href', '/' + package_name + '/api/download_torrent?hash=' + data.info_hash);
        // elapsed time
        let etime = data.time_metadata + Number(("time_scrape" in data) ? data.time_scrape : 0);
        document.getElementById("etime").innerHTML = '걸린 시간: ' + etime.toFixed(3) + '초';
        // torrent_info
        document.getElementById("div_torrent_info").innerHTML = "<pre>" + JSON.stringify(data, null, 2) + "</pre>";
        $('#div_torrent_info').collapse('show');
    }
</script>


{% endblock %}